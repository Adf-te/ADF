<!doctype html> 
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Accès requis</title>

  <!-- Anti-cache de la page -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <style>
    :root { --gap: 12px; }
    body { font-family: system-ui, sans-serif; max-width: 640px; margin: 6vh auto; padding: 0 16px; }
    .header { display: grid; gap: var(--gap); margin-bottom: 20px; }
    .hero { width: 100%; height: auto; border-radius: 12px; object-fit: cover; }
    form { display: grid; gap: var(--gap); }
    label { display: grid; gap: 6px; }
    input[type=password] { padding: 10px; font-size: 16px; width: 100%; }
    button { padding: 10px 14px; font-size: 16px; cursor: pointer; border-radius: 8px; }
    .toolbar { display: flex; gap: 8px; align-items: center; justify-content: space-between; }
    .hint { color: #666; font-size: 14px; }
    .err  { color: #b00020; min-height: 1.2em; }
    .audio-ctrl { display: inline-flex; gap: 8px; align-items: center; }
    .badge { font-size: 12px; color: #555; }
  </style>
</head>
<body>
  <div class="header">
    <!-- Image d'en-tête -->
    <img
      id="hero"
      class="hero"
      src="assets/visuel.jpeg"
      alt="Visuel de présentation"
      referrerpolicy="no-referrer"
      loading="lazy">
    <div class="toolbar">
      <div>
        <h1 style="margin:0;">Accès</h1>
        <p class="hint" style="margin:4px 0 0;">Entrez le mot de passe pour continuer.</p>
      </div>
      <!-- Contrôles audio -->
      <div class="audio-ctrl">
        <button id="toggleAudio" type="button">▶︎ Lire</button>
        <span id="audioState" class="badge">audio en veille</span>
      </div>
    </div>
  </div>

  <form id="f" autocomplete="off">
    <label>Mot de passe
      <input id="pwd" type="password" inputmode="text" autocomplete="current-password" required autofocus>
    </label>
    <label><input type="checkbox" id="remember"> Mémoriser sur cet appareil</label>
    <button type="submit">Entrer</button>
    <p id="msg" class="err" role="status" aria-live="polite"></p>
  </form>

  <!-- Lecteur audio caché (avec contrôles via JS) -->
  <audio id="bgm" preload="auto" loop playsinline>
    <source src="assets/musique.mp3" type="audio/mpeg">
    <!-- Ajoute d'autres formats si tu veux: OGG, WAV -->
  </audio>

  <script>
    // ========= PARAMÈTRES À ADAPTER =========
    const DESTINATION_URL = "https://chatgpt.com/"; // <- ta destination
    const HASH_HEX = "6b86b273ff34fce19d6b804eff5a3f5747ada4eaa22f1d49c01e52ddb7875b4b"; // hash SHA-256 du mot de passe
    const VERSION_TOKEN = "2025-10-14-2"; // incrémente quand tu veux forcer un refresh global
    // Si tes fichiers image/son changent, le cache-buster les actualise aussi :
    const MEDIA_BUST = VERSION_TOKEN + "-" + Date.now();

    // ========= ANTI-CACHE PAGE =========
    sessionStorage.clear(); // on garde la session propre (n'efface pas le "mémoriser")
    window.addEventListener('pageshow', (e) => { if (e.persisted) location.reload(true); });
    if ('caches' in window) { caches.keys().then(names => names.forEach(n => caches.delete(n))); }

    // Bust visuel si besoin (force le rafraîchissement de l'image si elle a été modifiée)
    const hero = document.getElementById('hero');
    hero.src = hero.src + (hero.src.includes('?') ? '&' : '?') + 'v=' + MEDIA_BUST;

    function makeCacheBustedUrl(url) {
      const sep = url.includes('?') ? '&' : '?';
      return url + sep + 'v=' + VERSION_TOKEN + '-' + Date.now();
    }

    // ========= MÉMO : SAUTER L'ÉCRAN SI DÉJÀ VALIDÉ =========
    const REMEMBER_KEY = "ok-global";
    if (localStorage.getItem(REMEMBER_KEY) === "1") {
      location.replace(makeCacheBustedUrl(DESTINATION_URL));
    }

    // ========= UTILITAIRES =========
    async function sha256Hex(text) {
      const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(text));
      return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2, "0")).join("");
    }

    // ========= FORMULAIRE =========
    const form = document.getElementById("f");
    const msg  = document.getElementById("msg");
    const PATH = location.pathname;
    const triesKey = "tries:" + PATH;
    const lockKey  = "lock-until:" + PATH;

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      msg.textContent = "";

      const now = Date.now();
      const lockUntil = parseInt(sessionStorage.getItem(lockKey) || "0", 10);
      if (now < lockUntil) {
        msg.textContent = "Trop d'essais. Réessayez dans quelques secondes.";
        return;
      }

      const pwd = document.getElementById("pwd").value;
      const remember = document.getElementById("remember").checked;
      const hash = await sha256Hex(pwd);

      if (hash === HASH_HEX) {
        if (remember) localStorage.setItem(REMEMBER_KEY, "1");
        sessionStorage.removeItem(triesKey);
        sessionStorage.removeItem(lockKey);
        location.replace(makeCacheBustedUrl(DESTINATION_URL));
      } else {
        const tries = 1 + parseInt(sessionStorage.getItem(triesKey) || "0", 10);
        sessionStorage.setItem(triesKey, String(tries));
        if (tries >= 5) {
          sessionStorage.setItem(lockKey, String(now + 30_000)); // blocage 30 s
          sessionStorage.setItem(triesKey, "0");
          msg.textContent = "Mot de passe incorrect. Verrouillage 30 s.";
        } else {
          msg.textContent = "Mot de passe incorrect.";
        }
      }
    });

    // ========= AUDIO : TENTATIVE D'AUTOPLAY + BOUTON =========
    const bgm = document.getElementById('bgm');
    const toggleBtn = document.getElementById('toggleAudio');
    const state = document.getElementById('audioState');

    // Essaye d'autoplay (sera souvent bloqué si non muet)
    (async () => {
      try {
        await bgm.play();
        toggleBtn.textContent = "⏸︎ Pause";
        state.textContent = "lecture";
      } catch {
        // Autoplay bloqué, on attend un geste utilisateur
        toggleBtn.textContent = "▶︎ Lire";
        state.textContent = "audio en veille";
      }
    })();

    toggleBtn.addEventListener('click', async () => {
      try {
        if (bgm.paused) {
          await bgm.play();
          toggleBtn.textContent = "⏸︎ Pause";
          state.textContent = "lecture";
        } else {
          bgm.pause();
          toggleBtn.textContent = "▶︎ Lire";
          state.textContent = "en pause";
        }
      } catch {
        state.textContent = "lecture impossible (politique d'autoplay)";
      }
    });
  </script>
</body>
</html>
